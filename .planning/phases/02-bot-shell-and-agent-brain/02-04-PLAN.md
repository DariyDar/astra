---
phase: 02-bot-shell-and-agent-brain
plan: 04
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/channels/slack/adapter.ts
  - src/bot/index.ts
  - .env.example
autonomous: true
requirements: [MSG-02, MSG-03]
user_setup:
  - service: slack
    why: "Slack bot for DM conversations with admin"
    env_vars:
      - name: SLACK_BOT_TOKEN
        source: "Slack App Settings -> OAuth & Permissions -> Bot User OAuth Token (xoxb-...)"
      - name: SLACK_APP_TOKEN
        source: "Slack App Settings -> Basic Information -> App-Level Tokens -> Generate (xapp-...) with connections:write scope"
      - name: SLACK_ADMIN_USER_ID
        source: "Slack workspace -> click your profile -> copy Member ID"
    dashboard_config:
      - task: "Create a Slack app at https://api.slack.com/apps"
        location: "Slack API dashboard"
      - task: "Enable Socket Mode in Settings -> Socket Mode"
        location: "Slack App Settings"
      - task: "Add Bot Token Scopes: chat:write, im:history, im:write, im:read"
        location: "OAuth & Permissions"
      - task: "Subscribe to bot events: message.im"
        location: "Event Subscriptions -> Subscribe to bot events"
      - task: "Install app to workspace"
        location: "OAuth & Permissions -> Install to Workspace"

must_haves:
  truths:
    - "User sends a DM to Astra in Slack and receives a contextually appropriate response"
    - "Slack adapter uses Socket Mode (no public URL required)"
    - "Bot works without Slack tokens configured (Slack adapter is optional)"
    - "Slack admin user is the only user who gets responses"
  artifacts:
    - path: "src/channels/slack/adapter.ts"
      provides: "Slack ChannelAdapter implementation using Bolt Socket Mode"
      exports: ["SlackAdapter"]
    - path: ".env.example"
      provides: "Updated environment variable documentation with Slack tokens"
      contains: "SLACK_BOT_TOKEN"
  key_links:
    - from: "src/channels/slack/adapter.ts"
      to: "@slack/bolt"
      via: "Bolt App with socketMode: true"
      pattern: "socketMode.*true"
    - from: "src/bot/index.ts"
      to: "src/channels/slack/adapter.ts"
      via: "SlackAdapter registered with MessageRouter"
      pattern: "SlackAdapter"
---

<objective>
Add Slack DM support via @slack/bolt with Socket Mode. Create a Slack ChannelAdapter that implements the same interface as Telegram, and wire it into the message router. Make Slack optional — bot works with Telegram-only if Slack tokens are not configured.

Purpose: MSG-02 requires Slack DM interaction. The ChannelAdapter abstraction means Slack messages flow through the same brain and memory system as Telegram, delivering identical conversational experience on both platforms. Socket Mode is chosen per research recommendation: no public URL needed, simpler deployment.

Output: Slack adapter implementing ChannelAdapter, updated bot entry point with optional Slack registration, updated .env.example with Slack configuration.
</objective>

<execution_context>
@C:/Users/dimsh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dimsh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bot-shell-and-agent-brain/02-RESEARCH.md
@.planning/phases/02-bot-shell-and-agent-brain/02-01-SUMMARY.md
@src/channels/types.ts
@src/bot/index.ts
@src/config/env.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @slack/bolt and create Slack adapter</name>
  <files>src/channels/slack/adapter.ts</files>
  <action>
Install the Slack SDK:
```bash
npm install @slack/bolt
```

Create `src/channels/slack/adapter.ts` implementing the `ChannelAdapter` interface:
- Class `SlackAdapter` implements `ChannelAdapter`
- Constructor accepts `{ botToken: string, appToken: string, adminUserId: string }`
- Creates a Bolt `App` instance with `{ token: botToken, socketMode: true, appToken: appToken }`
- `channelType` readonly property returns `'slack'`
- `onMessage(handler: MessageHandler)` — Register a Bolt `app.message()` listener that:
  1. Skips messages with `subtype` (edits, joins, bot messages, etc.)
  2. Checks admin guard: `message.user === adminUserId` — silently ignore non-admin
  3. Constructs `InboundMessage`:
     - `id`: `message.ts` (Slack message timestamp, unique per channel)
     - `channelType`: `'slack'`
     - `channelId`: `message.channel`
     - `userId`: `message.user`
     - `text`: `message.text ?? ''`
     - `timestamp`: `new Date(parseFloat(message.ts) * 1000)`
     - `replyToMessageId`: `message.thread_ts` (if in a thread)
  4. Calls `handler(inboundMessage)`
- `send(message: OutboundMessage)` — Call `app.client.chat.postMessage({ channel: message.channelId, text: message.text, ...(message.replyToMessageId ? { thread_ts: message.replyToMessageId } : {}) })`
- `start()` — Call `await app.start()`. Log "Slack adapter started (Socket Mode)"
- `stop()` — Call `await app.stop()`. Log "Slack adapter stopped"

Handle Bolt's `GenericMessageEvent` type correctly — the `message` parameter in the listener includes `user`, `text`, `ts`, `channel`, `subtype`, `thread_ts`. Use type narrowing or type assertion as needed for TypeScript compatibility.

Import `App` from `@slack/bolt`. Import types from `../types.js`. Import logger from `../../logging/logger.js`. Use ESM `.js` extensions.
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Verify SlackAdapter implements ChannelAdapter interface with start/stop/send/onMessage</manual>
  </verify>
  <done>Slack adapter created using Bolt Socket Mode with admin-only guard. Implements ChannelAdapter interface identical to Telegram adapter. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Slack adapter into bot entry point and update environment docs</name>
  <files>src/bot/index.ts, .env.example</files>
  <action>
Update `src/bot/index.ts` to conditionally create and register the Slack adapter:

After creating the TelegramAdapter and before creating the MessageRouter:
1. Check if `env.SLACK_BOT_TOKEN` and `env.SLACK_APP_TOKEN` and `env.SLACK_ADMIN_USER_ID` are all present
2. If yes: create `SlackAdapter` with those tokens, add to the adapters array
3. If no: log info "Slack not configured, running Telegram-only mode"
4. Pass all available adapters to MessageRouter constructor

The conditional logic should be:
```typescript
const adapters: ChannelAdapter[] = [telegramAdapter]

if (env.SLACK_BOT_TOKEN && env.SLACK_APP_TOKEN && env.SLACK_ADMIN_USER_ID) {
  const slackAdapter = new SlackAdapter({
    botToken: env.SLACK_BOT_TOKEN,
    appToken: env.SLACK_APP_TOKEN,
    adminUserId: env.SLACK_ADMIN_USER_ID,
  })
  adapters.push(slackAdapter)
  logger.info('Slack adapter configured')
} else {
  logger.info('Slack not configured, running Telegram-only mode')
}
```

Update `.env.example` to add Slack configuration section:
```
# --- Slack (optional — bot works without these) ---
# Create a Slack app at https://api.slack.com/apps
# Enable Socket Mode, add Bot Token Scopes: chat:write, im:history, im:write, im:read
# Subscribe to bot events: message.im
SLACK_BOT_TOKEN=
SLACK_APP_TOKEN=
SLACK_ADMIN_USER_ID=

# --- Qdrant ---
QDRANT_URL=http://localhost:6333
```

Add the Qdrant URL to .env.example as well since it was added to env.ts in Plan 01.

Import SlackAdapter from `../channels/slack/adapter.js`. Import ChannelAdapter from `../channels/types.js`.
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Verify bot/index.ts conditionally creates SlackAdapter only when all 3 Slack env vars are present; .env.example documents Slack and Qdrant vars</manual>
  </verify>
  <done>Slack adapter conditionally registered in bot entry point — present when configured, absent when not. Bot works in Telegram-only mode without Slack tokens. .env.example updated with Slack and Qdrant documentation.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Package.json includes @slack/bolt dependency
- SlackAdapter implements ChannelAdapter with Socket Mode
- Bot starts successfully without SLACK_* env vars (Telegram-only mode)
- Bot creates SlackAdapter when all three SLACK_* vars are present
- .env.example documents all new environment variables
- Admin guard prevents non-admin Slack users from getting responses
</verification>

<success_criteria>
- Slack DM messages from admin reach the same conversation brain as Telegram
- Socket Mode connects without requiring a public URL
- Non-admin Slack users are silently ignored
- Bot degrades gracefully to Telegram-only when Slack tokens are missing
- All environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/02-bot-shell-and-agent-brain/02-04-SUMMARY.md`
</output>
