---
phase: 03-core-integrations
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/integrations/monitors/clickup-deadlines.ts
  - src/integrations/monitors/calendar-reminders.ts
  - src/bot/index.ts
autonomous: true
requirements: [CAL-02]
user_setup: []

must_haves:
  truths:
    - "Bot checks ClickUp for tasks with deadlines within 24h or overdue every 30 minutes"
    - "Bot checks Google Calendar for upcoming meetings and sends reminders 15 minutes before"
    - "Deadline and reminder notifications go through the existing NotificationDispatcher"
    - "Monitors only run when their respective API credentials are configured"
    - "Bot starts without errors when ClickUp or Google credentials are missing"
  artifacts:
    - path: "src/integrations/monitors/clickup-deadlines.ts"
      provides: "ClickUp deadline monitor: cron job checking for approaching/overdue tasks"
      exports: ["ClickUpDeadlineMonitor"]
    - path: "src/integrations/monitors/calendar-reminders.ts"
      provides: "Calendar reminder: cron job checking for upcoming meetings"
      exports: ["CalendarReminderMonitor"]
  key_links:
    - from: "src/integrations/monitors/clickup-deadlines.ts"
      to: "src/notifications/dispatcher.ts"
      via: "dispatches NotificationItem with category task_deadline"
      pattern: "NotificationDispatcher"
    - from: "src/integrations/monitors/calendar-reminders.ts"
      to: "src/notifications/dispatcher.ts"
      via: "dispatches NotificationItem with category calendar_meeting"
      pattern: "NotificationDispatcher"
    - from: "src/bot/index.ts"
      to: "src/integrations/monitors/clickup-deadlines.ts"
      via: "starts/stops monitor in bot lifecycle"
      pattern: "ClickUpDeadlineMonitor"
---

<objective>
Build proactive monitoring: a ClickUp deadline monitor that alerts about tasks approaching deadline (within 24h) or overdue, and a Google Calendar reminder that sends notifications before upcoming meetings. Both use the existing NotificationDispatcher.

Purpose: Proactive alerts are a key value-add for PM workflow -- the bot doesn't just answer questions, it actively watches for problems and upcoming events.
Output: Two monitor modules + bot integration wiring.
</objective>

<execution_context>
@C:/Users/dimsh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dimsh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-integrations/03-RESEARCH.md
@.planning/phases/03-core-integrations/03-01-SUMMARY.md

# Key existing files
@src/config/env.ts
@src/notifications/dispatcher.ts
@src/notifications/urgency.ts
@src/notifications/digest.ts
@src/bot/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ClickUp deadline monitor and calendar reminder cron jobs</name>
  <files>
    src/integrations/monitors/clickup-deadlines.ts
    src/integrations/monitors/calendar-reminders.ts
  </files>
  <action>
1. **Create `src/integrations/monitors/clickup-deadlines.ts`**: Export a `ClickUpDeadlineMonitor` class.

   Constructor takes: `{ apiKey: string, teamId: string, dispatcher: NotificationDispatcher, adminUserId: string }`

   The class has:
   - `start()`: Starts a `node-cron` job running every 30 minutes (`*/30 * * * *`). Also runs an immediate check on start.
   - `stop()`: Stops the cron job.
   - `private async checkDeadlines()`: The core logic:
     a. Call ClickUp REST API: `GET https://api.clickup.com/api/v2/team/${teamId}/task` with query params:
        - `due_date_gt`: now minus 7 days (catch overdue tasks)
        - `due_date_lt`: now plus 24 hours (catch approaching tasks)
        - `statuses[]=open&statuses[]=in progress`
        - `include_closed=false`
     b. Parse response as `{ tasks: ClickUpTask[] }` where ClickUpTask has: `id, name, due_date (string|null), status: { status: string }, assignees: Array<{ username: string }>, url: string, list: { name: string }`
     c. Filter tasks where `due_date` is not null
     d. Categorize: overdue (due_date < now) and approaching (due_date within 24h)
     e. Track already-notified task IDs in a `Set<string>` to avoid duplicate alerts within a session (reset on bot restart is fine)
     f. For each new task, dispatch via `NotificationDispatcher.dispatch()`:
        - `userId`: `adminUserId`
        - `category`: `'task_deadline'`
        - `title`: "Overdue: {task.name}" or "Due soon: {task.name}"
        - `body`: "List: {task.list.name} | Status: {task.status.status} | Due: {formatted_date} | {task.url}"
        - `urgency`: overdue = 'urgent', approaching = 'important'
     g. Use native `fetch` for HTTP calls (Node.js 18+). Headers: `{ Authorization: apiKey }`.
     h. Wrap in try/catch. Log errors with pino logger. Never throw -- monitor failures must not crash the bot.

2. **Create `src/integrations/monitors/calendar-reminders.ts`**: Export a `CalendarReminderMonitor` class.

   Constructor takes: `{ dispatcher: NotificationDispatcher, adminUserId: string }`

   The class has:
   - `start()`: Starts a `node-cron` job running every 15 minutes (`*/15 * * * *`).
   - `stop()`: Stops the cron job.
   - `private async checkUpcomingEvents()`: The core logic:
     a. This monitor works differently from ClickUp -- it does NOT directly call Google Calendar API (that requires OAuth tokens managed by workspace-mcp). Instead, it invokes Claude with a specific prompt asking to check calendar events.

     IMPORTANT ARCHITECTURAL DECISION: On reflection, the Calendar reminder cannot use direct API calls because Google OAuth tokens are managed by workspace-mcp internally. Two options:

     **Option A (simpler, recommended):** Use the ClickUp deadline monitor pattern for ClickUp only. For calendar reminders, rely on Claude's proactive behavior -- update the system prompt to instruct Claude to mention upcoming meetings when relevant. This avoids the complexity of direct Google Calendar API access.

     **Option B (complex):** Build a separate Google Calendar API client with its own OAuth token management, duplicating what workspace-mcp does.

     IMPLEMENT OPTION A: The CalendarReminderMonitor should be a lightweight module that:
     a. Runs every 5 minutes
     b. Uses `callClaude` with a specific prompt: "Check my Google Calendar for events in the next 15 minutes that I haven't been reminded about. If there are any, list them with time and title. If none, respond with 'NO_UPCOMING'."
     c. Pass the MCP config path so Claude can access Google Calendar tools
     d. If response doesn't contain 'NO_UPCOMING', dispatch a notification:
        - `category`: `'calendar_meeting'`
        - `urgency`: `'urgent'` (15-min reminder is time-sensitive)
        - `title`: "Upcoming meeting"
        - `body`: Claude's formatted response
     e. Track reminded event descriptions in a `Set<string>` with TTL cleanup (remove entries older than 2h) to avoid duplicate reminders
     f. Wrap in try/catch. On error, log and continue silently.

   Import: `callClaude` from `../llm/client.js` (verified export exists at src/llm/client.ts line 19), `NotificationDispatcher` from notifications, logger from logging, `node-cron`.

   INTERVAL NOTE: 15 minutes (not 5) â€” spawning Claude CLI every 5 minutes is expensive (cold start ~7s each invocation). At 15-minute intervals, a meeting starting at minute 0 will be caught by the check at minute -15 (one cycle before). This is an acceptable tradeoff. If the user wants finer resolution, the system prompt approach (see Option A note above) is more efficient.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Review the two monitor files for correct API usage and error handling</manual>
  </verify>
  <done>
    - clickup-deadlines.ts exports ClickUpDeadlineMonitor with start/stop/checkDeadlines
    - calendar-reminders.ts exports CalendarReminderMonitor with start/stop/checkUpcomingEvents
    - Both use existing NotificationDispatcher for delivery
    - Both have deduplication to prevent repeated alerts
    - Both handle errors gracefully (log + continue)
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire monitors into bot entry point</name>
  <files>
    src/bot/index.ts
  </files>
  <action>
1. **Update `src/bot/index.ts`**: Add conditional monitor creation and lifecycle management.

   After the existing DigestScheduler setup:

   a. Import `ClickUpDeadlineMonitor` from `../integrations/monitors/clickup-deadlines.js`
   b. Import `CalendarReminderMonitor` from `../integrations/monitors/calendar-reminders.js`
   c. Conditionally create ClickUp monitor:
      ```typescript
      let clickUpMonitor: ClickUpDeadlineMonitor | undefined
      if (env.CLICKUP_API_KEY && env.CLICKUP_TEAM_ID) {
        clickUpMonitor = new ClickUpDeadlineMonitor({
          apiKey: env.CLICKUP_API_KEY,
          teamId: env.CLICKUP_TEAM_ID,
          dispatcher,  // existing NotificationDispatcher instance
          adminUserId: env.TELEGRAM_ADMIN_CHAT_ID,
        })
        clickUpMonitor.start()
        logger.info('ClickUp deadline monitor started')
      } else {
        logger.info('ClickUp credentials not configured, deadline monitor disabled')
      }
      ```
   d. Conditionally create Calendar monitor:
      ```typescript
      let calendarMonitor: CalendarReminderMonitor | undefined
      if (env.GOOGLE_OAUTH_CLIENT_ID && env.GOOGLE_OAUTH_CLIENT_SECRET) {
        calendarMonitor = new CalendarReminderMonitor({
          dispatcher,
          adminUserId: env.TELEGRAM_ADMIN_CHAT_ID,
        })
        calendarMonitor.start()
        logger.info('Calendar reminder monitor started')
      } else {
        logger.info('Google credentials not configured, calendar reminders disabled')
      }
      ```
   e. Add to graceful shutdown:
      ```typescript
      clickUpMonitor?.stop()
      calendarMonitor?.stop()
      ```

2. **Verify the existing graceful shutdown pattern** in bot/index.ts handles the new monitors. The monitors' `stop()` methods should be called alongside existing cleanup (digest cron stop, router stop, etc.).
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Review bot/index.ts for correct conditional creation and shutdown order</manual>
  </verify>
  <done>
    - ClickUp monitor created and started only when CLICKUP_API_KEY and CLICKUP_TEAM_ID are set
    - Calendar monitor created and started only when Google OAuth credentials are set
    - Both monitors stopped in graceful shutdown
    - Bot starts without errors when monitor env vars are missing
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Bot starts without errors when CLICKUP_API_KEY is not set
3. Bot starts without errors when GOOGLE_OAUTH_CLIENT_ID is not set
4. When both are set, both monitors log their start messages
</verification>

<success_criteria>
- ClickUp deadline monitor checks every 30 minutes, dispatches notifications for overdue and approaching tasks
- Calendar reminder checks every 15 minutes via Claude+MCP, dispatches reminders for upcoming meetings
- Both monitors are opt-in (only start when credentials configured)
- Both integrate with existing NotificationDispatcher
- Graceful shutdown stops both monitors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-integrations/03-02-SUMMARY.md`
</output>
