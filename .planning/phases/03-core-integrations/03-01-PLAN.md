---
phase: 03-core-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/env.ts
  - src/mcp/config-generator.ts
  - src/mcp/mcp-config.json
  - src/brain/system-prompt.ts
  - src/bot/index.ts
  - .env.example
autonomous: true
requirements: [CU-01, CU-02, CU-03, MAIL-01, MAIL-02, MAIL-03, CAL-01, DRIVE-01, DRIVE-02]
user_setup:
  - service: google-cloud
    why: "Google OAuth credentials for Gmail, Calendar, Drive access"
    env_vars:
      - name: GOOGLE_OAUTH_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_OAUTH_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Desktop app type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Enable Gmail API, Google Calendar API, Google Drive API"
        location: "Google Cloud Console -> APIs & Services -> Library"
  - service: clickup
    why: "ClickUp API access for task queries"
    env_vars:
      - name: CLICKUP_API_KEY
        source: "ClickUp -> Settings -> Apps -> Generate API Token"
      - name: CLICKUP_TEAM_ID
        source: "ClickUp URL: app.clickup.com/{team_id}/..."

must_haves:
  truths:
    - "MCP config includes google-workspace and clickup servers alongside existing astra-memory"
    - "System prompt instructs Claude when and how to use each integration tool"
    - "MCP config is generated dynamically at startup with actual env var values (no hardcoded secrets)"
    - "Bot starts correctly when integration env vars are missing (graceful degradation)"
    - "Integration env vars are optional in Zod schema -- bot works without them"
  artifacts:
    - path: "src/config/env.ts"
      provides: "Optional CLICKUP_API_KEY, CLICKUP_TEAM_ID, GOOGLE_OAUTH_CLIENT_ID, GOOGLE_OAUTH_CLIENT_SECRET env vars"
      contains: "CLICKUP_API_KEY"
    - path: "src/mcp/config-generator.ts"
      provides: "Dynamic MCP config generation with conditional server entries"
      exports: ["generateMcpConfig"]
    - path: "src/brain/system-prompt.ts"
      provides: "Integration tool guidance section in system prompt"
      contains: "Integration tools"
  key_links:
    - from: "src/mcp/config-generator.ts"
      to: "src/config/env.ts"
      via: "imports env for credential values"
      pattern: "import.*env"
    - from: "src/bot/index.ts"
      to: "src/mcp/config-generator.ts"
      via: "calls generateMcpConfig at startup"
      pattern: "generateMcpConfig"
    - from: "src/brain/router.ts"
      to: "src/mcp/mcp-config.json"
      via: "MCP_CONFIG_PATH reference (existing)"
      pattern: "MCP_CONFIG_PATH"
---

<objective>
Set up MCP integration infrastructure: add env vars for ClickUp and Google services, create a dynamic MCP config generator that conditionally adds integration servers based on available credentials, and update the system prompt with tool guidance so Claude routes queries to the correct MCP tools.

Purpose: Foundation for all four integrations (ClickUp, Gmail, Calendar, Drive). Without this, Claude cannot discover or call integration tools.
Output: Updated env.ts, new config-generator.ts, updated mcp-config.json (generated at startup), updated system-prompt.ts with integration tool section.
</objective>

<execution_context>
@C:/Users/dimsh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dimsh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-integrations/03-RESEARCH.md

# Key existing files
@src/config/env.ts
@src/mcp/mcp-config.json
@src/brain/system-prompt.ts
@src/brain/router.ts
@src/bot/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration env vars and dynamic MCP config generator</name>
  <files>
    src/config/env.ts
    src/mcp/config-generator.ts
    src/bot/index.ts
    .env.example
  </files>
  <action>
1. **Update `src/config/env.ts`**: Add optional env vars to the Zod schema:
   - `CLICKUP_API_KEY: z.string().optional()` -- ClickUp personal API token
   - `CLICKUP_TEAM_ID: z.string().optional()` -- ClickUp workspace team ID
   - `GOOGLE_OAUTH_CLIENT_ID: z.string().optional()` -- Google OAuth client ID
   - `GOOGLE_OAUTH_CLIENT_SECRET: z.string().optional()` -- Google OAuth client secret
   All MUST be optional so the bot starts without them (same pattern as Slack env vars).

2. **Create `src/mcp/config-generator.ts`**: New file. Export `generateMcpConfig(outputPath: string): void` function that:
   - Always includes `astra-memory` HTTP server at `http://127.0.0.1:3100/mcp`
   - Conditionally adds `google-workspace` stdio server if `GOOGLE_OAUTH_CLIENT_ID` AND `GOOGLE_OAUTH_CLIENT_SECRET` are set:
     - command: `uvx`, args: `['workspace-mcp', '--read-only', '--tools', 'gmail', 'drive', 'calendar']`
     - env block passes `GOOGLE_OAUTH_CLIENT_ID` and `GOOGLE_OAUTH_CLIENT_SECRET` from process env
   - Conditionally adds `clickup` stdio server if `CLICKUP_API_KEY` AND `CLICKUP_TEAM_ID` are set:
     - command: `npx`, args: `['-y', '@hauptsache.net/clickup-mcp@latest']`
     - env block passes `CLICKUP_API_KEY`, `CLICKUP_TEAM_ID`, and `CLICKUP_MCP_MODE: 'read'`
   - Uses `writeFileSync` to write the JSON to `outputPath`
   - Logs which servers were included using pino logger
   - Import env from `../config/env.js`, logger from `../logging/logger.js`

   Interface for the config:
   ```typescript
   interface McpServerConfig {
     type: 'http' | 'stdio'
     url?: string
     command?: string
     args?: string[]
     env?: Record<string, string>
   }
   ```

3. **Update `src/bot/index.ts`**: Add a call to `generateMcpConfig()` early in the startup sequence (before MessageRouter creation). The output path should be the same as `MCP_CONFIG_PATH` in router.ts: `resolve(fileURLToPath(import.meta.url), '../../mcp/mcp-config.json')`. Import `generateMcpConfig` from `../mcp/config-generator.js`.

4. **Update `.env.example`**: Add documentation for the new env vars:
   ```
   # --- ClickUp Integration (optional) ---
   # Personal API token from ClickUp Settings -> Apps
   # CLICKUP_API_KEY=pk_xxxxxxx
   # Team ID from ClickUp URL: app.clickup.com/{team_id}/...
   # CLICKUP_TEAM_ID=1234567

   # --- Google Workspace Integration (optional) ---
   # OAuth 2.0 Client credentials from Google Cloud Console
   # GOOGLE_OAUTH_CLIENT_ID=xxxx.apps.googleusercontent.com
   # GOOGLE_OAUTH_CLIENT_SECRET=GOCSPX-xxxxx
   ```
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check that mcp-config.json is generated at startup with correct structure</manual>
  </verify>
  <done>
    - env.ts has 4 new optional env vars (CLICKUP_API_KEY, CLICKUP_TEAM_ID, GOOGLE_OAUTH_CLIENT_ID, GOOGLE_OAUTH_CLIENT_SECRET)
    - config-generator.ts exports generateMcpConfig that conditionally adds MCP servers
    - bot/index.ts calls generateMcpConfig at startup
    - .env.example documents all new env vars
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: System prompt integration tool guidance</name>
  <files>
    src/brain/system-prompt.ts
  </files>
  <action>
1. **Update `src/brain/system-prompt.ts`**: Add a new section after the existing "## Notification Preferences" section. The section should be titled "## Integration tools" and describe each integration's tools and when to use them.

   The section content (add to the template string in `buildSystemPrompt`):
   ```
   ## Integration tools
   You have access to external service tools via MCP. Use them when the user asks about tasks, emails, calendar, or documents.

   **ClickUp** (searchTasks, getTaskById, searchSpaces, getListInfo, readDocument, searchDocuments):
   - Use when user asks about tasks, projects, deadlines, team work, sprints
   - searchTasks supports fuzzy matching -- use it for natural language queries
   - searchSpaces to browse workspace hierarchy
   - All operations are read-only

   **Gmail** (search_gmail_messages, get_gmail_message):
   - Use when user asks about emails, inbox, priority messages
   - Classify emails by urgency based on sender, subject, and content
   - For digest requests, search with "is:unread" and summarize by priority
   - Read-only: cannot send or reply to emails

   **Google Calendar** (list_calendar_events, get_calendar_event):
   - Use when user asks about schedule, meetings, today/this week
   - Format events clearly with time, title, and attendees
   - Read-only: cannot create or modify events

   **Google Drive** (search_drive_files, get_drive_file_content):
   - Use when user asks about documents, files, GDDs, specs, notes
   - Can search by name and read document content
   - Read-only: cannot create or modify files

   **Multi-source queries:**
   When user asks something like "show everything this week" or "what's going on?":
   - Call ClickUp, Calendar, and Gmail tools in parallel
   - Merge results into a single organized response grouped by source

   **Error handling:**
   - If a tool call fails, retry once silently
   - If still failing, tell the user which specific service is unavailable
   - Never fabricate data -- if results are empty, say so explicitly ("No tasks found", "No unread emails")
   ```

   IMPORTANT: Only add this section if it doesn't already exist. Preserve all existing prompt content exactly as-is. The new section goes AFTER the notification preferences section but BEFORE the closing backtick of the template string.

2. **Keep the function signature unchanged**: `buildSystemPrompt(language: Language, channelId: string): string`. No new parameters needed -- the integration tool names are static regardless of which MCP servers are configured (Claude will get tool-not-found errors gracefully if a server isn't configured).
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Read system-prompt.ts and verify the integration section is present and correct</manual>
  </verify>
  <done>
    - system-prompt.ts contains "## Integration tools" section with all 4 integration descriptions
    - Each integration lists specific tool names, when to use them, and read-only constraint
    - Multi-source query guidance and error handling instructions are present
    - Existing prompt content is preserved exactly
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `node --import tsx src/mcp/config-generator.ts` -- module loads without runtime errors
3. Generated `mcp-config.json` has correct structure with conditional server entries
4. System prompt output includes integration tool section when called
</verification>

<success_criteria>
- All 4 integration env vars present in env.ts as optional
- Dynamic MCP config generator creates correct JSON with astra-memory + conditional google-workspace + conditional clickup
- System prompt includes integration tool guidance for all 4 services
- Bot starts without errors when integration env vars are not set
- TypeScript compilation clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-integrations/03-01-SUMMARY.md`
</output>
